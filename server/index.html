<!DOCTYPE html>
<html>
    <head>
        <title>WebRTC Demo - FabLab Project</title>

        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.js"></script>
        <script src="socket.io.js"></script>
        <script src="simplewebrtc.bundle.js"></script>

        <link rel="stylesheet" href="lib/css/bootstrap.min.css">
        <link rel="stylesheet" href="lib/css/bootstrap-theme.min.css">
        <script src="lib/js/bootstrap.min.js"></script>

        <link rel="stylesheet" type="text/css" href="style/page-design.css" />
        <script type="text/javascript" src="js/display.js"></script>

    </head>
    <body>
        <div id="navbar" class="navbar navbar-inverse navbar-fixed-top">
            <div class="row row-margin">
                <div class="navbar-header menu-margin">
                    <h2 class="site-description">Fablabs</h2>
                </div>
            </div>
            <div class="row row-margin">
                <div class="panel-group" id="fablabsMenu">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a href="?Grenoble">Grenoble</a>
                            </h4>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a href="?Lyon">Lyon</a>
                            </h4>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a href="?Rennes">Rennes</a>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content content-extra">
            <div class="container">

                <h1 id="title">Start a room</h1>
                <div id="subTitle"></div>
                <form id="createRoom" class="form-inline">
                    <div class="form-group" style="margin-bottom:10px;">
                        <input id="sessionInput" class="form-control"/>
                        <button type="submit" type="button" class="btn btn-default">Create it!</button>
                    </div>
                </form>

                <!-- Contient notre vidÃ©o -->
                <div class="row">
                    <div style="height:400px;" id="principal">
                    </div>
                </div>
                <div id="miniature" class="row miniature">
                    <video id="localVideo" class="miniature-video">
                    your browser does not support the HTML 5 video tag
                    </video>
                    <!-- contains the video of the remote fablabs -->
                    <span id="remotes"></span>
                </div>
            </div>

            <script>
                // grab the room from the URL
                var room = location.search && location.search.split('?')[1];

                // create our webrtc connection
                var webrtc = new SimpleWebRTC({
                    // the id/element dom element that will hold "our" video
                    localVideoEl: 'localVideo',
                    // the id/element dom element that will hold remote videos
                    remoteVideosEl: 'remotes',
                    // immediately ask for camera access
                    autoRequestMedia: true,
                    debug: true,
                    detectSpeakingEvents: true,
                    autoAdjustMic: false
                });

                // when it's ready, join if we got a room from the URL
                webrtc.on('readyToCall', function () {
                    // you can name it anything
                    if (room) webrtc.joinRoom(room);
                });

                // Since we use this twice we put it here
                function setRoom(name) {
                    $('form').remove();
                    $('h1').text('Room name : ' + name);
                    $('body').addClass('active');
                }

                if (room) {
                    setRoom(room);
                    } else {
                    $('form').submit(function () {
                        console.log("regarde");
                        var val = $('#sessionInput').val().toLowerCase().replace(/\s/g, '-').replace(/[^A-Za-z0-9_\-]/g, '');
                        webrtc.createRoom(val, function (err, name) {
                            console.log(' create room cb', arguments);

                            var newUrl = location.pathname + '?' +  name;
                            if (!err) {
                                history.replaceState({foo: 'bar'}, null, newUrl);
                                setRoom(name);
                                } else {
                                console.log(err);
                            }
                        });
                        return false;
                    });
                }

                var button = $('#screenShareButton'),
                setButton = function (bool) {
                    button.text(bool ? 'share screen' : 'stop sharing');
                };

                setButton(true);

                button.click(function () {
                    if (webrtc.getLocalScreen()) {
                        webrtc.stopScreenShare();
                        setButton(true);
                        } else {
                        webrtc.shareScreen(function (err) {
                            if (err) {
                                setButton(true);
                                } else {
                                setButton(false);
                            }
                        });

                    }
                });

            </script>

        </div>
    </body>
</html>
